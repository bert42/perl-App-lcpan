#!perl

# DATE
# VERSION

use 5.010;
use strict;
use warnings;

use App::lcpan;
use Perinci::CmdLine::Any -prefer_lite=>1;

my $prefix = '/App/lcpan/';

Perinci::CmdLine::Any->new(
    url => $prefix,
    log => 1,
    subcommands => {
        update          => {url=>"${prefix}update_local_cpan"},
        'update-index'  => {url=>"${prefix}update_local_cpan_index"},
        'update-files'  => {url=>"${prefix}update_local_cpan_files"},

        stats       => {url=>"${prefix}stat_local_cpan"},

        authors     => {url=>"${prefix}list_local_cpan_authors"},
        modules     => {url=>"${prefix}list_local_cpan_modules"},
        dists       => {url=>"${prefix}list_local_cpan_dists"},
        releases    => {url=>"${prefix}list_local_cpan_releases"},
        deps        => {url=>"${prefix}list_local_cpan_deps"},
        rdeps       => {url=>"${prefix}list_local_cpan_rev_deps"},

        mod2dist    => {url=>"${prefix}mod2dist"},
        mod2rel     => {url=>"${prefix}mod2rel"},
        dist2rel    => {url=>"${prefix}dist2rel"},

        distmods    => {url=>"${prefix}distmods"},

        authormods  => {url=>"${prefix}authormods"},
        authordists => {url=>"${prefix}authordists"},
        authorrels  => {url=>"${prefix}authorrels"},
    },
)->run;

# ABSTRACT: Manage your local CPAN mirror
# PODNAME:

=head1 SYNOPSIS

=head2 Update (download and index) your local CPAN mirror

 % lcpan update

A mini CPAN mirror will be downloaded in your C<~/cpan> directory. This will
take a while (it downloads +- 4GB of files, as of this writing; subsequent
update will of course take shorter time.)

A SQLite database is also created/updated in C<~/cpan/index.db> which contains
information about authors, modules/packages, distributions. This database is
used for quickly answer various queries.

You can run the above command e.g. daily to keep your mirror up-to-date.

=head2 Using your local CPAN mirror to install modules

 % lcpanm -n Some::Module

C<lcpanm> is a thin wrapper for C<cpanm>, the above command is equivalent to:

 % cpanm --mirror ~/cpan --mirror-only -n Some::Module

=head2 Querying your local CPAN mirror

Info about your local CPAN mirror:

 % lcpan stats
 +------------------+----------------------+
 | name             | value                |
 +------------------+----------------------+
 | authors          | 11967                |
 | distributions    | 29907                |
 | last-updated     | 2015-01-09T10:40:55Z |
 | modules          | 13365                |
 | packages         | 133650               |
 +------------------+----------------------+

Add C<--verbose> if you want more stats which normally are skipped because they
can take a while to get (e.g. disk-space).

B<List modules:>

 % lcpan modules
 % lcpan modules SOMEQUERY --detail
 % lcpan modules --author PERLANCAR ;# modules by some author only
 % lcpan modules --dist libwww-perl ;# from certain dist only

B<List distributions:>

 % lcpan dists
 % lcpan dists SOMEQUERY --detail
 % lcpan dists --author PERLANCAR ;# from certain author only

B<List authors:>

 % lcpan authors
 % lcpan authors SOMEQUERY --detail

B<List releases (tarballs):>

 % lcpan releases
 % lcpan releases SOMEQUERY --detail
 % lcpan releases --author PERLANCAR ;# from certain authors only
 % lcpan releases --author PERLANCAR ;# from certain authors only

B<Show dependencies and reverse dependencies>:

 % lcpan deps Text::ANSITable    ;# which modules does Text::ANSITable depend on?
 % lcpan deps Text::ANSITable -R ;# recursive
 % lcpan deps Task::BeLike::CSSON --phase build
 % lcpan deps Text::ANSITable --phase ALL --rel ALL

 % lcpan rdeps Text::ANSITable ;# which dists depend on Text::ANSITable?

B<Some other utilities>:

 % lcpan mod2dist Text::ANSITable::ColorTheme::Default ;# -> Text-ANSITable

 % lcpan mod2rel  Text::ANSITable::ColorTheme::Default ;# -> Text-ANSITable-0.39.tar.gz
 % lcpan mod2rel  Text::ANSITable --full-path          ;# -> /cpan/authors/id/P/PE/PERLANCAR/Text-ANSITable-0.39.tar.gz

 % lcpan dist2rel Text-ANSITable             ;# -> Text-ANSITable-0.39.tar.gz
 % lcpan dist2rel Text-ANSITable --full-path ;# -> /cpan/authors/id/P/PE/PERLANCAR/Text-ANSITable-0.39.tar.gz

 % lcpan distmods Text-ANSITable ;# list modules in a distribution
 Text::ANSITable
 Text::ANSITable::BorderStyle::Default
 Text::ANSITable::ColorTheme::Default
 Text::ANSITable::StyleSet::AltRow

 % lcpan authormods PERLANCAR   ;# list an author's modules
 % lcpan authordists PERLANCAR  ;# list an author's dists
 % lcpan authorrels PERLANCAR   ;# list an author's releases

B<Some sample queries for CPAN authors>:

Show other people using my modules on CPAN (replace with your CPAN ID):

 % for mod in `lcpan modules --author PERLANCAR`; do
     res=`lcpan rdeps "$mod" --author-isnt PERLANCAR --format text-pretty`
     if [[ "$res" != "" ]]; then echo -e "$mod is used by:\n$res\n"; fi
   done


=head1 DESCRIPTION

This application is a convenient bundling of C<CPAN::Mini> and an indexer so in
addition to creating your local CPAN mirror and installing modules from it, you
can also query various things about your local CPAN mirror quickly from the
command-line (as well as programmatically).


=head1 FAQ

=head2 How to customize location of local CPAN mirror?

By default CPAN mirror is put in C<~/cpan>. To customize this, use the C<--cpan>
option, e.g.:

 % lcpan update --cpan /path/to/my/cpan

You can also create a configuration C<~/lcpan.conf> so you don't have to specify
the C<--cpan> option everytime:

 cpan=/path/to/my/cpan

=head2 Where is the SQLite database index located?

In C<$cpan/index.db>.

=head2 How do I reindex from scratch (without downloading the mirror)?

Just delete the C<index.db> and run C<lcpan update-index> again.

=head2 How do I download the mirror without indexing?

Run C<lcpan update-files>.


=head1 SEE ALSO
